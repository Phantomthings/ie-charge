<div style="display:flex; flex-direction:column; gap:1.25rem;">
    <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius-sm); padding:1rem; display:flex; flex-direction:column; gap:1rem;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap;">
            <div style="font-weight:700; color:var(--color-text);">Statistiques par site</div>
            <div style="font-size:0.85rem; color:var(--color-text-muted);">OK = r√©ussi ¬∑ NOK = √©chec</div>
        </div>
        {% if site_rows %}
        <div style="overflow:auto; border:1px solid var(--color-border); border-radius:var(--radius-sm);">
            <table style="width:100%; border-collapse:collapse; min-width:640px;">
                <thead style="background:var(--color-bg);">
                    <tr>
                        {% for col in ["Site", "Total_Charges", "Charges_OK", "Charges_NOK", "% R√©ussite", "% √âchec"] %}
                        <th style="text-align:left; padding:0.6rem; font-size:0.85rem; color:var(--color-text-muted); border-bottom:1px solid var(--color-border); white-space:nowrap;">{{ col }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in site_rows %}
                    <tr style="border-bottom:1px solid var(--color-border);">
                        <td style="padding:0.55rem; font-weight:600; color:var(--color-text);">{{ row['Site'] }}</td>
                        <td style="padding:0.55rem;">{{ row['Total_Charges'] }}</td>
                        <td style="padding:0.55rem; color:#15803d;">{{ row['Charges_OK'] }}</td>
                        <td style="padding:0.55rem; color:#dc2626;">{{ row['Charges_NOK'] }}</td>
                        <td style="padding:0.55rem; color:#1d4ed8;">{{ row['% R√©ussite'] }}%</td>
                        <td style="padding:0.55rem; color:#b91c1c;">{{ row['% √âchec'] }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; flex-wrap:wrap;">
            <div style="padding:0.75rem; border:1px solid var(--color-border); border-radius:var(--radius-sm); background:var(--color-bg);">
                <div style="font-weight:600; margin-bottom:0.5rem; color:var(--color-text);">Volumes OK / NOK</div>
                <div style="display:flex; flex-direction:column; gap:0.5rem;">
                    {% for row in count_bars %}
                    {% set ok_ratio = (row.ok / max_total * 100) if max_total else 0 %}
                    {% set nok_ratio = (row.nok / max_total * 100) if max_total else 0 %}
                    <div style="display:flex; align-items:center; gap:0.5rem;">
                        <div style="width:110px; font-weight:600; color:var(--color-text);">{{ row.site }}</div>
                        <div style="flex:1; background:var(--color-surface); border:1px solid var(--color-border); border-radius:6px; overflow:hidden; display:flex; height:20px;">
                            <div style="width:{{ ok_ratio }}%; background:#38AC21;"></div>
                            <div style="width:{{ nok_ratio }}%; background:#ef4444;"></div>
                        </div>
                        <div style="width:120px; display:flex; justify-content:space-between; font-size:0.85rem; color:var(--color-text-muted);">
                            <span>{{ row.ok }}</span>
                            <span>{{ row.nok }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div style="padding:0.75rem; border:1px solid var(--color-border); border-radius:var(--radius-sm); background:var(--color-bg);">
                <div style="font-weight:600; margin-bottom:0.5rem; color:var(--color-text);">R√©partition en pourcentage</div>
                <div style="display:flex; flex-direction:column; gap:0.5rem;">
                    {% for row in percent_bars %}
                    <div style="display:flex; align-items:center; gap:0.5rem;">
                        <div style="width:110px; font-weight:600; color:var(--color-text);">{{ row.site }}</div>
                        <div style="flex:1; background:var(--color-surface); border:1px solid var(--color-border); border-radius:6px; overflow:hidden; display:flex; height:20px;">
                            <div style="width:{{ row.ok_pct }}%; background:#38AC21;"></div>
                            <div style="width:{{ row.nok_pct }}%; background:#ef4444;"></div>
                        </div>
                        <div style="width:120px; display:flex; justify-content:space-between; font-size:0.85rem; color:var(--color-text-muted);">
                            <span>{{ row.ok_pct }}%</span>
                            <span>{{ row.nok_pct }}%</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">üìä</div>
            <div>Aucune donn√©e disponible pour ce p√©rim√®tre.</div>
        </div>
        {% endif %}
    </div>

    <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius-sm); padding:1rem; display:flex; flex-direction:column; gap:1rem;">
        <div style="font-weight:700; color:var(--color-text);">Analyse temporelle</div>
        {% if peak_rows %}
        <div style="overflow:auto; border:1px solid var(--color-border); border-radius:var(--radius-sm);">
            <table style="width:100%; border-collapse:collapse; min-width:560px;">
                <thead style="background:var(--color-bg);">
                    <tr>
                        <th style="text-align:left; padding:0.6rem; font-size:0.85rem; color:var(--color-text-muted); border-bottom:1px solid var(--color-border);">Site</th>
                        <th style="text-align:left; padding:0.6rem; font-size:0.85rem; color:var(--color-text-muted); border-bottom:1px solid var(--color-border);">Heure de pic</th>
                        <th style="text-align:left; padding:0.6rem; font-size:0.85rem; color:var(--color-text-muted); border-bottom:1px solid var(--color-border);">Nb au pic</th>
                        <th style="text-align:left; padding:0.6rem; font-size:0.85rem; color:var(--color-text-muted); border-bottom:1px solid var(--color-border);">Heure m√©diane</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in peak_rows %}
                    <tr style="border-bottom:1px solid var(--color-border);">
                        <td style="padding:0.55rem; font-weight:600; color:var(--color-text);">{{ row.site }}</td>
                        <td style="padding:0.55rem;">{{ row.peak_hour }}</td>
                        <td style="padding:0.55rem;">{{ row.peak_nb }}</td>
                        <td style="padding:0.55rem;">{{ row.median_hour }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">‚è±Ô∏è</div>
            <div>Aucune heure de charge valide pour ce p√©rim√®tre.</div>
        </div>
        {% endif %}

        <div style="display:flex; flex-direction:column; gap:0.75rem;">
            <div style="font-weight:600; color:var(--color-text);">Heatmap des charges par heure</div>
            {% if heatmap_rows %}
            <div style="overflow:auto; border:1px solid var(--color-border); border-radius:var(--radius-sm);">
                <table style="border-collapse:collapse; min-width:780px; width:100%;">
                    <thead style="background:var(--color-bg);">
                        <tr>
                            <th style="position:sticky; left:0; background:var(--color-bg); padding:0.6rem; border-bottom:1px solid var(--color-border); text-align:left; font-size:0.85rem; color:var(--color-text-muted);">Site</th>
                            {% for hour in heatmap_hours %}
                            <th style="padding:0.6rem; border-bottom:1px solid var(--color-border); font-size:0.85rem; color:var(--color-text-muted); text-align:center;">{{ "%02d:00" % hour }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in heatmap_rows %}
                        <tr>
                            <td style="position:sticky; left:0; background:var(--color-bg); padding:0.55rem; font-weight:600; color:var(--color-text); border-bottom:1px solid var(--color-border);">{{ row.site }}</td>
                            {% for value in row.values %}
                            {% set ratio = (value / heatmap_max * 0.85) if heatmap_max else 0 %}
                            {% set text_color = '#0f172a' if ratio < 0.55 else '#ffffff' %}
                            <td style="padding:0.5rem; border-bottom:1px solid var(--color-border); text-align:center; background:rgba(37,99,235,{{ '%.3f' % ratio }}); color:{{ text_color }}; font-weight:600;">{{ value }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">üßä</div>
                <div>Pas assez de donn√©es pour afficher la heatmap horaire.</div>
            </div>
            {% endif %}
        </div>
    </div>

    <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius-sm); padding:1rem; display:flex; flex-direction:column; gap:1rem;">
        <div style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:center; justify-content:space-between;">
            <div style="font-weight:700; color:var(--color-text);">Zoom site et p√©riodicit√©</div>
            <form hx-get="/api/sessions/comparaison" hx-target="#tab-content" hx-swap="innerHTML" style="display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
                <input type="hidden" name="sites" value="{{ filters.sites }}">
                <input type="hidden" name="date_debut" value="{{ filters.date_debut }}">
                <input type="hidden" name="date_fin" value="{{ filters.date_fin }}">
                <input type="hidden" name="error_types" value="{{ filters.error_types }}">
                <input type="hidden" name="moments" value="{{ filters.moments }}">
                <select name="site_focus" onchange="this.form.requestSubmit()" class="select-input" style="min-width:220px;">
                    {% for opt in site_options %}
                    <option value="{{ opt }}" {% if opt == site_focus %}selected{% endif %}>{{ opt }}</option>
                    {% endfor %}
                </select>
                <input type="hidden" name="month_focus" value="{{ month_focus }}">
            </form>
        </div>

        {% if site_focus %}
        <div style="display:flex; flex-direction:column; gap:1rem;">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                <div style="border:1px solid var(--color-border); border-radius:var(--radius-sm); padding:0.75rem; background:var(--color-bg);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                        <div style="font-weight:600; color:var(--color-text);">Distribution mensuelle OK / NOK ‚Äî {{ site_focus }}</div>
                        <form hx-get="/api/sessions/comparaison" hx-target="#tab-content" hx-swap="innerHTML" style="display:flex; gap:0.5rem; align-items:center;">
                            <input type="hidden" name="sites" value="{{ filters.sites }}">
                            <input type="hidden" name="date_debut" value="{{ filters.date_debut }}">
                            <input type="hidden" name="date_fin" value="{{ filters.date_fin }}">
                            <input type="hidden" name="error_types" value="{{ filters.error_types }}">
                            <input type="hidden" name="moments" value="{{ filters.moments }}">
                            <input type="hidden" name="site_focus" value="{{ site_focus }}">
                            <select name="month_focus" onchange="this.form.requestSubmit()" class="select-input">
                                {% for m in month_options %}
                                <option value="{{ m }}" {% if m == month_focus %}selected{% endif %}>{{ m }}</option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>
                    {% if monthly_rows %}
                    <div style="overflow:auto;">
                        <table style="width:100%; border-collapse:collapse; min-width:520px;">
                            <thead style="background:var(--color-bg);">
                                <tr>
                                    <th style="text-align:left; padding:0.6rem; font-size:0.85rem; color:var(--color-text-muted); border-bottom:1px solid var(--color-border);">Mois</th>
                                    <th style="text-align:left; padding:0.6rem; font-size:0.85rem; color:var(--color-text-muted); border-bottom:1px solid var(--color-border);">OK</th>
                                    <th style="text-align:left; padding:0.6rem; font-size:0.85rem; color:var(--color-text-muted); border-bottom:1px solid var(--color-border);">NOK</th>
                                    <th style="text-align:left; padding:0.6rem; font-size:0.85rem; color:var(--color-text-muted); border-bottom:1px solid var(--color-border);">OK %</th>
                                    <th style="text-align:left; padding:0.6rem; font-size:0.85rem; color:var(--color-text-muted); border-bottom:1px solid var(--color-border);">NOK %</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in monthly_rows %}
                                <tr style="border-bottom:1px solid var(--color-border);">
                                    <td style="padding:0.55rem; font-weight:600; color:var(--color-text);">{{ row.month }}</td>
                                    <td style="padding:0.55rem; color:#15803d;">{{ row.ok }}</td>
                                    <td style="padding:0.55rem; color:#dc2626;">{{ row.nok }}</td>
                                    <td style="padding:0.55rem;">{{ row.ok_pct }}%</td>
                                    <td style="padding:0.55rem;">{{ row.nok_pct }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">üìÖ</div>
                        <div>Aucune distribution mensuelle disponible.</div>
                    </div>
                    {% endif %}
                </div>

                <div style="border:1px solid var(--color-border); border-radius:var(--radius-sm); padding:0.75rem; background:var(--color-bg);">
                    <div style="font-weight:600; color:var(--color-text); margin-bottom:0.5rem;">D√©tail journalier ‚Äî {{ site_focus }} {% if month_focus %}({{ month_focus }}){% endif %}</div>
                    {% if daily_rows %}
                    <div style="overflow:auto;">
                        <table style="width:100%; border-collapse:collapse; min-width:520px;">
                            <thead style="background:var(--color-bg);">
                                <tr>
                                    <th style="text-align:left; padding:0.6rem; font-size:0.85rem; color:var(--color-text-muted); border-bottom:1px solid var(--color-border);">Jour</th>
                                    <th style="text-align:left; padding:0.6rem; font-size:0.85rem; color:var(--color-text-muted); border-bottom:1px solid var(--color-border);">OK</th>
                                    <th style="text-align:left; padding:0.6rem; font-size:0.85rem; color:var(--color-text-muted); border-bottom:1px solid var(--color-border);">NOK</th>
                                    <th style="text-align:left; padding:0.6rem; font-size:0.85rem; color:var(--color-text-muted); border-bottom:1px solid var(--color-border);">OK %</th>
                                    <th style="text-align:left; padding:0.6rem; font-size:0.85rem; color:var(--color-text-muted); border-bottom:1px solid var(--color-border);">NOK %</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in daily_rows %}
                                <tr style="border-bottom:1px solid var(--color-border);">
                                    <td style="padding:0.55rem; font-weight:600; color:var(--color-text);">{{ row.day }}</td>
                                    <td style="padding:0.55rem; color:#15803d;">{{ row.ok }}</td>
                                    <td style="padding:0.55rem; color:#dc2626;">{{ row.nok }}</td>
                                    <td style="padding:0.55rem;">{{ row.ok_pct }}%</td>
                                    <td style="padding:0.55rem;">{{ row.nok_pct }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">üìÜ</div>
                        <div>Aucun d√©tail journalier pour la s√©lection actuelle.</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">üè∑Ô∏è</div>
            <div>Aucun site disponible apr√®s filtres.</div>
        </div>
        {% endif %}
    </div>
</div>
